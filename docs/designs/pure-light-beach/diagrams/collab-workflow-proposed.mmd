flowchart TB
    subgraph Entry["ðŸš€ /collab Entry"]
        Start([User: /collab])
        CheckServer{Server running?}
        StartServer["Tell user to start server"]
        ServerFailed["âŒ STOP - Server required"]
        FindSessions{Sessions exist?}
        ShowSessions[Show session list]
        ResumeOrNew{Resume or New?}
        CreateSession["Create .collab/name/"]
    end

    subgraph Gathering["ðŸ“‹ gather-session-goals skill (NEW)"]
        GS_Ask["What do you want to\naccomplish this session?"]
        GS_Explore["Explore with user:\nâ€¢ What problems?\nâ€¢ What features?\nâ€¢ What bugs?"]
        GS_Classify["Classify each item:\nâ€¢ feature\nâ€¢ bugfix\nâ€¢ refactor\nâ€¢ spike"]
        GS_CreateList["Create work item list\nin design doc"]
        GS_Confirm{User confirms list?}
        GS_Revise["Revise list"]
    end

    subgraph ItemLoop["ðŸ”„ Work Item Loop"]
        IL_NextItem{Next item?}
        IL_GetItem["Get item from list"]
        IL_Type{Item type?}
        IL_MarkComplete["Mark item complete\nin design doc"]
        IL_AllDone["All items documented"]
    end

    subgraph Debugging["ðŸ” systematic-debugging skill\n(INVESTIGATION ONLY)"]
        DB_ReadError["Read error messages carefully\nâ€¢ Stack traces\nâ€¢ Line numbers"]
        DB_Reproduce["Reproduce consistently\nâ€¢ Exact steps\nâ€¢ Every time?"]
        DB_RecentChanges["Check recent changes\nâ€¢ Git diff\nâ€¢ New deps"]
        DB_Trace["Trace data flow\n(root-cause-tracing.md)"]
        DB_Hypothesis["Form hypothesis:\n'X is root cause because Y'"]
        DB_Test["Test minimally:\nONE change at a time"]
        DB_Found{Root cause found?}
        DB_FailCount{Fixes tried?}
        DB_QuestionArch["STOP: Question architecture\nDiscuss with human"]
        DB_Document["Document root cause\n& proposed fix approach\n(DO NOT IMPLEMENT)"]
    end

    subgraph Brainstorming["ðŸ’¡ brainstorming skill"]
        BS_Exploring[EXPLORING\nGather context]
        BS_Clarifying[CLARIFYING\nOne item at a time]
        BS_Designing[DESIGNING\n200-300 word sections]
        BS_Validating{Item complete?}
        BS_GateFailed["Missing:\nâ€¢ Problem/Goal\nâ€¢ Approach\nâ€¢ Success Criteria"]
    end

    subgraph DesignDoc["ðŸ“„ Design Document Structure"]
        DD_Header["# Session: name\n## Session Context\n**Out of Scope:**\n**Shared Decisions:**"]
        DD_Items["## Work Items"]
        DD_Item1["### Item 1: title\n**Type:** feature|bugfix\n**Status:** pending|documented\n**Problem/Goal:**\n**Approach:**\n**Root Cause:** (if bugfix)\n**Success Criteria:**\n**Decisions:**"]
        DD_ItemN["### Item N: ..."]
        DD_Diagrams["## Diagrams\n(auto-synced)"]
    end

    subgraph ReadyGate["ðŸšª ready-to-implement skill"]
        RI_ReadDesign[Read design doc]
        RI_CheckAll{All items documented?}
        RI_ListIncomplete["List incomplete items"]
        RI_Confirm{Ready for rough-draft?}
    end

    subgraph RoughDraft["ðŸ“ rough-draft skill"]
        RD_Interface["INTERFACE\n(for ALL items)"]
        RD_Verify1["âš¡ verify-phase skill"]
        RD_Pseudocode["PSEUDOCODE\n(for ALL items)"]
        RD_Verify2["âš¡ verify-phase skill"]
        RD_Skeleton["SKELETON\nâ€¢ Stub files\nâ€¢ Task dependency graph"]
        RD_Verify3["âš¡ verify-phase skill"]
        RD_HandoffOptions{Implementation where?}
    end

    subgraph Drift["ðŸ”€ Drift Handling"]
        DriftDetected["Drift detected"]
        DriftChoice{User choice?}
        DriftAccept["Accept: Update design"]
        DriftReject["Reject: Redo phase"]
        DriftPartial["Partial: Specify keeps"]
    end

    subgraph Executing["âš™ï¸ executing-plans skill"]
        EX_ParseGraph[Parse task dependency graph]
        EX_CreateDiagram["Create task-execution diagram"]
        EX_FindReady["Find ready tasks"]
        EX_Dispatch["Dispatch via\nsubagent-driven-development"]
        EX_MoreTasks{More tasks?}
        EX_AllDone["All tasks complete"]
    end

    subgraph Finishing["âœ… finishing-a-development-branch"]
        FN_Verify{Tests pass?}
        FN_Options{What to do?}
        FN_Merge["Merge"]
        FN_PR["Create PR"]
        FN_Keep["Keep branch"]
    end

    subgraph Cleanup["ðŸ§¹ collab-cleanup skill"]
        CL_Summary[Show session summary]
        CL_Choice{Artifacts?}
        CL_Archive["Archive"]
        CL_Delete["Delete"]
        CL_Done([Session complete])
    end

    %% Entry flow
    Start --> CheckServer
    CheckServer -->|No| StartServer --> ServerFailed
    CheckServer -->|Yes| FindSessions
    FindSessions -->|Yes| ShowSessions --> ResumeOrNew
    FindSessions -->|No| CreateSession --> GS_Ask
    ResumeOrNew -->|New| CreateSession
    ResumeOrNew -->|Resume| RI_ReadDesign

    %% Gathering flow (NEW)
    GS_Ask --> GS_Explore --> GS_Classify --> GS_CreateList --> GS_Confirm
    GS_Confirm -->|No| GS_Revise --> GS_Classify
    GS_Confirm -->|Yes| IL_NextItem

    %% Item loop
    IL_NextItem -->|Yes| IL_GetItem --> IL_Type
    IL_NextItem -->|No| IL_AllDone --> RI_ReadDesign

    %% Route by type
    IL_Type -->|"bugfix"| DB_ReadError
    IL_Type -->|"feature\nrefactor\nspike"| BS_Exploring

    %% Debugging flow (investigation only - NO FIXING)
    DB_ReadError --> DB_Reproduce --> DB_RecentChanges --> DB_Trace
    DB_Trace --> DB_Hypothesis --> DB_Test --> DB_Found
    DB_Found -->|Yes| DB_Document --> IL_MarkComplete
    DB_Found -->|No| DB_FailCount
    DB_FailCount -->|"< 3"| DB_Hypothesis
    DB_FailCount -->|"â‰¥ 3"| DB_QuestionArch --> DB_Document

    %% Brainstorming flow (for features)
    BS_Exploring --> BS_Clarifying --> BS_Designing --> BS_Validating
    BS_Validating -->|Pass| IL_MarkComplete
    BS_Validating -->|Fail| BS_GateFailed --> BS_Designing

    %% After item complete, loop back
    IL_MarkComplete --> IL_NextItem

    %% Ready gate (after all items documented)
    RI_ReadDesign --> RI_CheckAll
    RI_CheckAll -->|No| RI_ListIncomplete --> IL_NextItem
    RI_CheckAll -->|Yes| RI_Confirm
    RI_Confirm -->|Yes| RD_Interface
    RI_Confirm -->|No| IL_NextItem

    %% Rough-draft (processes ALL items together)
    RD_Interface --> RD_Verify1
    RD_Verify1 -->|Aligned| RD_Pseudocode
    RD_Verify1 -->|Drift| DriftDetected
    RD_Pseudocode --> RD_Verify2
    RD_Verify2 -->|Aligned| RD_Skeleton
    RD_Verify2 -->|Drift| DriftDetected
    RD_Skeleton --> RD_Verify3
    RD_Verify3 -->|Aligned| RD_HandoffOptions
    RD_Verify3 -->|Drift| DriftDetected

    %% Drift handling
    DriftDetected --> DriftChoice
    DriftChoice -->|Accept| DriftAccept --> RD_Interface
    DriftChoice -->|Reject| DriftReject --> RD_Interface
    DriftChoice -->|Partial| DriftPartial --> RD_Interface

    %% Handoff
    RD_HandoffOptions --> EX_ParseGraph

    %% Executing
    EX_ParseGraph --> EX_CreateDiagram --> EX_FindReady --> EX_Dispatch
    EX_Dispatch --> EX_MoreTasks
    EX_MoreTasks -->|Yes| EX_FindReady
    EX_MoreTasks -->|No| EX_AllDone --> FN_Verify

    %% Finishing
    FN_Verify -->|Pass| FN_Options
    FN_Options --> FN_Merge --> CL_Summary
    FN_Options --> FN_PR --> CL_Summary
    FN_Options --> FN_Keep --> CL_Summary

    %% Cleanup
    CL_Summary --> CL_Choice
    CL_Choice --> CL_Archive --> CL_Done
    CL_Choice --> CL_Delete --> CL_Done

    %% Design doc structure (floating reference)
    DD_Header ~~~ DD_Items
    DD_Items ~~~ DD_Item1
    DD_Item1 ~~~ DD_ItemN
    DD_ItemN ~~~ DD_Diagrams

    %% Styles
    style Entry fill:#e3f2fd,stroke:#1976d2
    style Gathering fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    style ItemLoop fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    style Debugging fill:#ffebee,stroke:#c62828
    style Brainstorming fill:#fff3e0,stroke:#ff9800
    style DesignDoc fill:#fafafa,stroke:#9e9e9e,stroke-dasharray: 5 5
    style ReadyGate fill:#c8e6c9,stroke:#388e3c
    style RoughDraft fill:#f3e5f5,stroke:#9c27b0
    style Drift fill:#fff9c4,stroke:#f9a825
    style Executing fill:#e8f5e9,stroke:#4caf50
    style Finishing fill:#fce4ec,stroke:#e91e63
    style Cleanup fill:#efebe9,stroke:#795548
    style ServerFailed fill:#ffcdd2,stroke:#c62828
    style DB_QuestionArch fill:#fff9c4,stroke:#f9a825
    style BS_GateFailed fill:#fff9c4,stroke:#f9a825
    style RI_ListIncomplete fill:#fff9c4,stroke:#f9a825
    style IL_AllDone fill:#c8e6c9,stroke:#2e7d32
    style DB_Document fill:#bbdefb,stroke:#1976d2,stroke-width:2px