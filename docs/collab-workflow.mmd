flowchart TB
    subgraph START [" "]
        direction TB
        User(["/collab"])
    end

    subgraph SESSION ["Session Setup"]
        direction TB
        CheckServer["Check Server Running"]
        FindSession{"Existing\nSessions?"}
        CreateSession["Create New Session\n• Generate name\n• Create folders\n• Initialize files"]
        ResumeSession["Resume Session"]
    end

    subgraph GOALS ["Gather Goals"]
        direction TB
        GatherGoals["gather-session-goals\n• Ask: What to accomplish?\n• Infer types from context\n• Anything else? loop"]
    end

    subgraph WORKLOOP ["Work Item Loop"]
        direction TB
        FindPending{"Find Pending\nItem"}

        subgraph BUGFIX ["Bugfix Path"]
            Debug["systematic-debugging\n• Root cause analysis\n• Documentation only\n• NO fixing allowed"]
        end

        subgraph FEATURE ["Feature/Refactor/Spike Path"]
            Brainstorm["brainstorming\n• EXPLORING: gather context\n• CLARIFYING: discuss items\n• DESIGNING: propose approaches\n• VALIDATING: completeness gate"]
        end

        MarkDone["Mark Item\nDocumented"]
    end

    subgraph READY ["Validation"]
        ReadyCheck["ready-to-implement\n• Verify all items documented\n• Confirm proceed"]
    end

    subgraph ROUGHDRAFT ["Rough Draft Phases"]
        direction TB
        Interface["Phase 1: INTERFACE\n• File paths & signatures\n• Type definitions\n• Component interactions"]
        Pseudocode["Phase 2: PSEUDOCODE\n• Logic flow\n• Error handling\n• Edge cases"]
        Skeleton["Phase 3: SKELETON\n• Document stub files\n• Task dependency graph\n• Mermaid visualization"]
        Handoff["Phase 4: HANDOFF\n• Option: Current dir\n• Option: Git worktree"]
    end

    subgraph EXECUTE ["Implementation"]
        direction TB
        ExecPlan["executing-plans\n• Parse dependency graph\n• Topological sort\n• Parallel dispatch"]
        TaskLoop{"More\nTasks?"}
        RunTask["Execute Task\n• subagent-driven-development\n• Update diagram state\n• Verify against design"]
        Complete["All Tasks Complete"]
    end

    subgraph FINISH ["Completion"]
        direction TB
        FinishBranch["finishing-a-development-branch\n• Verify tests pass\n• Merge/PR/Keep/Discard"]
        Cleanup["collab-cleanup\n• Archive to docs/designs/\n• Or delete session\n• Or keep for reference"]
    end

    %% Main flow
    User --> CheckServer
    CheckServer --> FindSession
    FindSession -->|"New"| CreateSession
    FindSession -->|"Resume"| ResumeSession
    CreateSession --> GatherGoals
    ResumeSession --> ReadyCheck

    GatherGoals --> FindPending

    FindPending -->|"Bugfix"| Debug
    FindPending -->|"Feature/Refactor/Spike"| Brainstorm
    FindPending -->|"None Left"| ReadyCheck

    Debug --> MarkDone
    Brainstorm --> MarkDone
    MarkDone --> FindPending

    ReadyCheck -->|"Confirmed"| Interface
    ReadyCheck -->|"Pending Items"| FindPending

    Interface --> Pseudocode
    Pseudocode --> Skeleton
    Skeleton --> Handoff
    Handoff --> ExecPlan

    ExecPlan --> TaskLoop
    TaskLoop -->|"Yes"| RunTask
    RunTask --> TaskLoop
    TaskLoop -->|"No"| Complete

    Complete --> FinishBranch
    FinishBranch --> Cleanup

    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#fff3e0,stroke:#e65100,stroke-width:1px
    classDef decision fill:#fce4ec,stroke:#880e4f,stroke-width:1px
    classDef phase fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px

    class User,Cleanup startEnd
    class CheckServer,CreateSession,ResumeSession,GatherGoals,Debug,Brainstorm,MarkDone,ReadyCheck,Interface,Pseudocode,Skeleton,Handoff,ExecPlan,RunTask,Complete,FinishBranch process
    class FindSession,FindPending,TaskLoop decision
